#!/bin/bash

this_dir=$(cd $(dirname $0);pwd)
this_script=$(basename $0)

. $this_dir/functions
#--- Variables
isoImage="pfSense-CE-2.3.2-RELEASE-amd64.iso"
isoImagePath=$this_dir/../${isoImage}
isoURL=https://frafiles.pfsense.org/mirror/downloads/${isoImage}.gz

isoGz="${isoImage}.gz"
isoURL="https://frafiles.pfsense.org/mirror/downloads/${isoImage}.gz"
if [ ! -e "$isoImage" ]; then
       if [ ! -e "$isoGz" ]; then
               wget "$isoURL"
       else
               gunzip "$isoGz"
       fi
fi


sshPort=9998
hosts="fw01 fw02"

WAN_IP=192.168.149.1
WAN_SUBNET=255.255.255.0

WAN_IP=192.168.149.1
WAN_SUBNET=255.255.255.0

WAN_IP=192.168.149.1
WAN_SUBNET=255.255.255.0


#========================================================
# MAIN
#========================================================

#--- configure Virtualbox networks

WAN_Network=$(createHostOnlyNetwork)
LAN_Network=$(createHostOnlyNetwork)
SYNC_Network=$(createHostOnlyNetwork)

setupWAN ${WAN_Network}
setupLAN ${LAN_Network}
setupSYNC ${SYNC_Network}

for vmName in ${hosts}
do

    VBoxManage createvm --name "$vmName" --register
    vmDir=$(VBoxManage showvminfo "$vmName" | grep "^Config file:"  | awk -F":" '{print $2}' | xargs -L1 -IX dirname "X")
    VBoxManage modifyvm "$vmName" --memory 256 --acpi on --boot1 dvd --vram 33 --cpus 1

    #--- Network cards
    VBoxManage modifyvm "$vmName" --nic1 hostonly --nictype1 82540EM --hostonlyadapter1 ${WAN_Network}
    VBoxManage modifyvm "$vmName" --nic2 hostonly --nictype2 82540EM --hostonlyadapter2 ${LAN_Network}
    VBoxManage modifyvm "$vmName" --nic3 hostonly --nictype3 82540EM --hostonlyadapter3 ${SYNC_Network}

    #--- Promiscous mode for WAN and LAN
    VBoxManage modifyvm "$vmName"  --nicpromisc1 allow-all
    VBoxManage modifyvm "$vmName"  --nicpromisc2 allow-all

    VBoxManage modifyvm "$vmName" --ostype FreeBSD_64
    VBoxManage modifyvm "$vmName"  --ioapic on
    VBoxManage modifyvm "$vmName"  --boot1 disk
    VBoxManage modifyvm "$vmName"  --boot2 dvd

    VBoxManage createhd --filename "$vmDir/${vmName}.vdi" --size 2000
    VBoxManage storagectl "$vmName" --name "SATA" --add sata
    VBoxManage storageattach "$vmName" --storagectl "SATA" --port 0 --device 0 --type hdd --medium "${vmDir}/${vmName}.vdi"
    VBoxManage storagectl "$vmName" --name "IDE" --add ide
    VBoxManage storageattach "$vmName" --storagectl "IDE" --port 1 --device 0 --type dvddrive --medium "$isoImage"

    VBoxManage showvminfo "$vmName"
    VBoxManage startvm "$vmName"

    (( sshPort += 1 ))
done

